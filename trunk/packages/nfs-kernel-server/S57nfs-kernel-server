#!/bin/sh

prefix="/opt"
PATH=${prefix}/bin:${prefix}/sbin:/sbin:/bin:/usr/sbin:/usr/bin

NFS_D=/opt/var/lib/nfs
LOCK_D=/opt/var/lib/nfs/sm

start() {
	echo "starting nfs-kernel-server"
	grep -q /proc/fs/nfsd /proc/mounts || mount -t nfsd nfsd /proc/fs/nfsd
	mkdir -p $NFS_D
	mkdir -p $LOCK_D
	touch $NFS_D/rmtab
#	echo 32777 > /proc/fs/nfs/nlm_tcpport
#	echo 32777 > /proc/fs/nfs/nlm_udpport
	/opt/sbin/rpc.statd -p 32778 -o 32779
	/opt/sbin/exportfs -r
	/opt/sbin/rpc.nfsd
	/opt/sbin/rpc.mountd -p 32780
	}

stop() {
	echo "stopping nfs-kernel-server"
	killall rpc.mountd
	/opt/sbin/rpc.nfsd 0 2> /dev/null
	/opt/sbin/exportfs -au
	killall rpc.statd
	grep -q /proc/fs/nfsd /proc/mounts && umount /proc/fs/nfsd
	}

reconfigure() {
	echo "reconfiguring  nfs-kernel-server"
	/opt/sbin/exportfs -r
	}

case "$1" in
	start)
		start
		;;
	stop)
		stop
		;;
	restart)
		stop
		sleep 4
		start
		;;
	reconfigure) reconfigure
		;;
	*)
		echo "Usage: $0 (start|stop|restart|reconfigure)"
		exit 1
		;;
esac

exit 0
