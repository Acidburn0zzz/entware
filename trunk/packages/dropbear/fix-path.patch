diff -urx .svn ../../../downloads/openwrt_trunk-r34120/package/network/services/dropbear/Makefile ../../../openwrt_trunk/package/network/services/dropbear/Makefile
--- ../../../downloads/openwrt_trunk-r34120/package/network/services/dropbear/Makefile	2012-11-08 16:16:56.018940003 +0400
+++ ../../../openwrt_trunk/package/network/services/dropbear/Makefile	2012-11-09 10:02:03.621776023 +0400
@@ -40,9 +40,9 @@
 endef
 
 define Package/dropbear/conffiles
-/etc/dropbear/dropbear_rsa_host_key
-/etc/dropbear/dropbear_dss_host_key 
-/etc/config/dropbear 
+/opt/etc/dropbear/dropbear_rsa_host_key
+/opt/etc/dropbear/dropbear_dss_host_key 
+/opt/etc/config/dropbear 
 endef
 
 define Package/dropbearconvert
@@ -69,12 +69,11 @@
 	--disable-zlib \
 	--enable-bundled-libtom
 
-TARGET_CFLAGS += -DARGTYPE=3 -ffunction-sections -fdata-sections
-TARGET_LDFLAGS += -Wl,--gc-sections
-
 define Build/Configure
 	$(SED) 's,^/\* #define PKG_MULTI.*,#define PKG_MULTI,g' $(PKG_BUILD_DIR)/options.h
 	$(SED) 's,^#define DO_HOST_LOOKUP,/* & */,g' $(PKG_BUILD_DIR)/options.h
+	$(SED) 's,/etc/dropbear/dropbear_,/opt/etc/dropbear/dropbear_,g' $(PKG_BUILD_DIR)/options.h
+	$(SED) 's,^#define MOTD_FILENAME "/etc/motd",#define MOTD_FILENAME "/opt/etc/motd",g' $(PKG_BUILD_DIR)/options.h
 	$(call Build/Configure/Default)
 endef
 
@@ -91,26 +90,32 @@
 endef
 
 define Package/dropbear/install
-	$(INSTALL_DIR) $(1)/usr/sbin
-	$(INSTALL_BIN) $(PKG_BUILD_DIR)/dropbearmulti $(1)/usr/sbin/dropbear
-	$(INSTALL_DIR) $(1)/usr/bin
-	ln -sf ../sbin/dropbear $(1)/usr/bin/scp
-	ln -sf ../sbin/dropbear $(1)/usr/bin/ssh
-	ln -sf ../sbin/dropbear $(1)/usr/bin/dbclient
-	ln -sf ../sbin/dropbear $(1)/usr/bin/dropbearkey
-	$(INSTALL_DIR) $(1)/etc/config
-	$(INSTALL_DATA) ./files/dropbear.config $(1)/etc/config/dropbear
-	$(INSTALL_DIR) $(1)/etc/init.d
-	$(INSTALL_BIN) ./files/dropbear.init $(1)/etc/init.d/dropbear
-	$(INSTALL_DIR) $(1)/usr/lib/opkg/info
-	$(INSTALL_DIR) $(1)/etc/dropbear
-	touch $(1)/etc/dropbear/dropbear_rsa_host_key
-	touch $(1)/etc/dropbear/dropbear_dss_host_key
+	$(INSTALL_DIR) $(1)/opt/sbin
+	$(INSTALL_BIN) $(PKG_BUILD_DIR)/dropbearmulti $(1)/opt/sbin/dropbear
+	$(INSTALL_DIR) $(1)/opt/bin
+	ln -sf ../sbin/dropbear $(1)/opt/bin/scp
+	ln -sf ../sbin/dropbear $(1)/opt/bin/ssh
+	ln -sf ../sbin/dropbear $(1)/opt/bin/dbclient
+	ln -sf ../sbin/dropbear $(1)/opt/bin/dropbearkey
+	$(INSTALL_DIR) $(1)/opt/etc/dropbear $(1)/opt/etc/init.d
+	$(INSTALL_BIN) ./files/S51dropbear $(1)/etc/init.d/
+endef
+
+define package/network/services/dropbear/postinst
+#!/bin/sh
+
+if [ ! -f /opt/etc/dropbear/dropbear_rsa_host_key ]; then
+    /opt/bin/dropbearkey -t rsa -f /opt/etc/dropbear/dropbear_rsa_host_key
+fi
+
+if [ ! -f /opt/etc/dropbear/dropbear_dss_host_key ]; then
+    /opt/bin/dropbearkey -t dss -f /opt/etc/dropbear/dropbear_dss_host_key
+fi
 endef
 
 define Package/dropbearconvert/install
-	$(INSTALL_DIR) $(1)/usr/bin
-	$(INSTALL_BIN) $(PKG_BUILD_DIR)/dropbearconvert $(1)/usr/bin/dropbearconvert
+	$(INSTALL_DIR) $(1)/opt/bin
+	$(INSTALL_BIN) $(PKG_BUILD_DIR)/dropbearconvert $(1)/opt/bin/dropbearconvert
 endef
 
 $(eval $(call BuildPackage,dropbear))
diff -urx .svn ../../../downloads/openwrt_trunk-r34120/package/network/services/dropbear/patches/100-pubkey_path.patch ../../../openwrt_trunk/package/network/services/dropbear/patches/100-pubkey_path.patch
--- ../../../downloads/openwrt_trunk-r34120/package/network/services/dropbear/patches/100-pubkey_path.patch	2012-11-08 16:16:56.054940002 +0400
+++ ../../../openwrt_trunk/package/network/services/dropbear/patches/100-pubkey_path.patch	2012-11-09 09:49:16.933789819 +0400
@@ -28,7 +28,7 @@
 +		/* open the file */
 +		authfile = fopen(filename, "r");
 +	} else {
-+		authfile = fopen("/etc/dropbear/authorized_keys","r");
++		authfile = fopen("/opt/etc/dropbear/authorized_keys","r");
 +	}
  	if (authfile == NULL) {
  		goto out;
@@ -58,10 +58,10 @@
 -	if (checkfileperm(filename) != DROPBEAR_SUCCESS) {
 -		goto out;
 +	if (ses.authstate.pw_uid == 0) {
-+		if (checkfileperm("/etc/dropbear") != DROPBEAR_SUCCESS) {
++		if (checkfileperm("/opt/etc/dropbear") != DROPBEAR_SUCCESS) {
 +			goto out;
 +		}
-+		if (checkfileperm("/etc/dropbear/authorized_keys") != DROPBEAR_SUCCESS) {
++		if (checkfileperm("/opt/etc/dropbear/authorized_keys") != DROPBEAR_SUCCESS) {
 +			goto out;
 +		}
 +	} else {
diff -urx .svn ../../../downloads/openwrt_trunk-r34120/package/network/services/dropbear/patches/120-openwrt_options.patch ../../../openwrt_trunk/package/network/services/dropbear/patches/120-openwrt_options.patch
--- ../../../downloads/openwrt_trunk-r34120/package/network/services/dropbear/patches/120-openwrt_options.patch	2012-11-08 16:16:56.054940002 +0400
+++ ../../../openwrt_trunk/package/network/services/dropbear/patches/120-openwrt_options.patch	2012-11-09 09:49:16.933789819 +0400
@@ -1,6 +1,6 @@
 --- a/options.h
 +++ b/options.h
-@@ -38,7 +38,7 @@
+@@ -38,7 +43,7 @@
   * Both of these flags can be defined at once, don't compile without at least
   * one of them. */
  #define NON_INETD_MODE
@@ -9,7 +9,7 @@
  
  /* Setting this disables the fast exptmod bignum code. It saves ~5kB, but is
   * perhaps 20% slower for pubkey operations (it is probably worth experimenting
-@@ -49,7 +49,7 @@
+@@ -49,7 +54,7 @@
  several kB in binary size however will make the symmetrical ciphers and hashes
  slower, perhaps by 50%. Recommended for small systems that aren't doing
  much traffic. */
@@ -18,7 +18,7 @@
  
  /* Enable X11 Forwarding - server only */
  #define ENABLE_X11FWD
-@@ -78,7 +78,7 @@ much traffic. */
+@@ -78,7 +83,7 @@
  
  /* Enable "Netcat mode" option. This will forward standard input/output
   * to a remote TCP-forwarded connection */
@@ -27,7 +27,7 @@
  
  /* Encryption - at least one required.
   * Protocol RFC requires 3DES and recommends AES128 for interoperability.
-@@ -89,8 +89,8 @@ much traffic. */
+@@ -89,8 +94,8 @@
  #define DROPBEAR_AES256
  /* Compiling in Blowfish will add ~6kB to runtime heap memory usage */
  /*#define DROPBEAR_BLOWFISH*/
@@ -38,7 +38,7 @@
  
  /* Enable "Counter Mode" for ciphers. This is more secure than normal
   * CBC mode against certain attacks. This adds around 1kB to binary 
-@@ -110,7 +110,7 @@ much traffic. */
+@@ -110,7 +115,7 @@
   * If you disable MD5, Dropbear will fall back to SHA1 fingerprints,
   * which are not the standard form. */
  #define DROPBEAR_SHA1_HMAC
@@ -47,7 +47,12 @@
  #define DROPBEAR_MD5_HMAC
  
  /* Hostkey/public key algorithms - at least one required, these are used
-@@ -148,7 +148,7 @@ much traffic. */
+@@ -144,15 +149,15 @@
+ #endif
+ 
+ /* Whether to do reverse DNS lookups. */
+-#define DO_HOST_LOOKUP
++/* #define DO_HOST_LOOKUP */
  
  /* Whether to print the message of the day (MOTD). This doesn't add much code
   * size */
@@ -56,7 +61,12 @@
  
  /* The MOTD file path */
  #ifndef MOTD_FILENAME
-@@ -192,7 +192,7 @@ much traffic. */
+-#define MOTD_FILENAME "/etc/motd"
++#define MOTD_FILENAME "/opt/etc/motd"
+ #endif
+ 
+ /* Authentication Types - at least one required.
+@@ -192,7 +197,7 @@
   * note that it will be provided for all "hidden" client-interactive
   * style prompts - if you want something more sophisticated, use 
   * SSH_ASKPASS instead. Comment out this var to remove this functionality.*/
@@ -65,3 +75,33 @@
  
  /* Define this (as well as ENABLE_CLI_PASSWORD_AUTH) to allow the use of
   * a helper program for the ssh client. The helper program should be
+@@ -237,25 +242,25 @@
+ /* The default file to store the daemon's process ID, for shutdown
+    scripts etc. This can be overridden with the -P flag */
+ #ifndef DROPBEAR_PIDFILE
+-#define DROPBEAR_PIDFILE "/var/run/dropbear.pid"
++#define DROPBEAR_PIDFILE "/opt/var/run/dropbear.pid"
+ #endif
+ 
+ /* The command to invoke for xauth when using X11 forwarding.
+  * "-q" for quiet */
+ #ifndef XAUTH_COMMAND
+-#define XAUTH_COMMAND "/usr/bin/X11/xauth -q"
++#define XAUTH_COMMAND "/opt/bin/X11/xauth -q"
+ #endif
+ 
+ /* if you want to enable running an sftp server (such as the one included with
+  * OpenSSH), set the path below. If the path isn't defined, sftp will not
+  * be enabled */
+ #ifndef SFTPSERVER_PATH
+-#define SFTPSERVER_PATH "/usr/libexec/sftp-server"
++#define SFTPSERVER_PATH "/opt/libexec/sftp-server"
+ #endif
+ 
+ /* This is used by the scp binary when used as a client binary. If you're
+  * not using the Dropbear client, you'll need to change it */
+-#define _PATH_SSH_PROGRAM "/usr/bin/dbclient"
++#define _PATH_SSH_PROGRAM "/opt/bin/dbclient"
+ 
+ /* Whether to log commands executed by a client. This only logs the 
+  * (single) command sent to the server, not what a user did in a 
diff -urx .svn ../../../downloads/openwrt_trunk-r34120/package/network/services/dropbear/patches/500-set-default-path.patch ../../../openwrt_trunk/package/network/services/dropbear/patches/500-set-default-path.patch
--- ../../../downloads/openwrt_trunk-r34120/package/network/services/dropbear/patches/500-set-default-path.patch	2012-11-08 16:16:56.054940002 +0400
+++ ../../../openwrt_trunk/package/network/services/dropbear/patches/500-set-default-path.patch	2012-11-09 09:49:16.949789814 +0400
@@ -5,7 +5,7 @@
  
  /* The default path. This will often get replaced by the shell */
 -#define DEFAULT_PATH "/usr/bin:/bin"
-+#define DEFAULT_PATH "/bin:/sbin:/usr/bin:/usr/sbin"
++#define DEFAULT_PATH "/bin:/sbin:/usr/bin:/usr/sbin:/opt/bin:/opt/sbin"
  
  /* Some other defines (that mostly should be left alone) are defined
   * in sysoptions.h */
